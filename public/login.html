<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>

    <script src="login.js"></script>

    <link rel="stylesheet" type="text/css" href="login.css">
</head>
<body>
    <div id="state_login" style="display: block">
        <h1>Login</h1>

        <br>
        <p id="login-log" style="color: red;"></p>
        <br>

        <label for="login-email">Email:</label><br>
        <input type="email" placeholder="john@smith.com" id="login-email">

        <br><br>

        <label for="login-password">Password:</label><br>
        <input type="password" placeholder="secret-password" id="login-password">

        <br><br>

        <button id="login-submit" disabled>Login</button>
        <br>
        <button id="login-switch" class="link" disabled>Don't have an account? Click here to signup.</button>
    </div>

    <div id="state_signup" style="display: none;">
        <h1>Signup</h1>

        <br>
        <p id="signup-log" style="color: red;"></p>
        <br>

        <label for="signup-name">Name:</label><br>
        <input type="text" placeholder="John Smith" id="signup-name">

        <br><br>

        <label for="signup-email">Email:</label><br>
        <input type="email" placeholder="john@smith.com" id="signup-email">

        <br><br>

        <label for="signup-password">Password:</label><br>
        <input type="password" placeholder="secret-password" id="signup-password">

        <br><br>

        <label for="signup-username">Username:</label><br>
        <input type="text" placeholder="jsmith94" id="signup-username">

        <br><br>

        <button id="signup-submit">Signup</button>
        <br>
        <button id="signup-switch" class="link">Don't have an account? Click here to signup.</button>
    </div>

    <div id="state_account" style="display: none;">
        <h1>Account</h1>

        <br>
        <p id="account-log" style="color: red"></p>
        <p>
            Current Information:
            <ul style="list-style-type: none;">
                <li>Name: <span id="account-data-name">&lt;loading&gt;</span></li>
                <li>Email: <span id="account-data-email">&lt;loading&gt;</span></li>
                <li>Username: <span id="account-data-username">&lt;loading&gt;</span></li>
                <li>Statistics:</li>
                <ul style="list-style-type: none">
                    <li style="margin-left: 1em">High Score: <span id="account-data-highscore">&lt;loading&gt;</span></li>
                    <li style="margin-left: 1em">Time Played: <span id="account-data-timeplayed">&lt;loading&gt;</span></li>
                </ul>
            </ul>
        </p>
        <br>

        <label for="account-name">Name:</label>
        <input type="text" placeholder="John Smith" id="account-name">

        <br><br>

        <label for="account-email">Email:</label>
        <input type="email" placeholder="john@smith.com" id="account-email">

        <br><br>

        <label for="account-password">Password:</label>
        <input type="password" placeholder="secret-password" id="account-password">

        <br><br>

        <label for="account-username">Username:</label>
        <input type="text" placeholder="jsmith94" id="account-username">

        <br><br>

        <button id="account-submit">Update</button>
        <br><br>
        <button id="account-play">Play Game</button>
        <br><br>
        <button id="account-logout">Logout</button>
    </div>

    <script>
        let state = STATES.LOGIN;

        // Event listeners for login
        document.getElementById("login-switch").onclick = () => {
            state = STATES.SIGNUP;
            document.getElementById("login-log").innerText = "";
            document.getElementById("login-email").value = "";
            document.getElementById("login-password").value = "";
        };
        document.getElementById("login-submit").onclick = (e) => {
            e.target.disabled = true;
            userLogin(document.getElementById("login-email").value, document.getElementById("login-password").value).then(() => {
                userData().then(data => {
                    localStorage.setItem("user", JSON.stringify(data));

                    document.getElementById("account-data-name").innerText = data.name;
                    document.getElementById("account-data-email").innerText = data.email;
                    document.getElementById("account-data-username").innerText = data.username;
                    document.getElementById("account-data-highscore").innerText = data.statistics.highscore;
                    document.getElementById("account-data-timeplayed").innerText = data.statistics.time_played;

                    state = STATES.ACCOUNT;
                    e.target.disabled = false;
                }).catch(err => {
                    document.getElementById("account-log").innerText = capitalizeFirstLetter(err.toString());
                });
            }).catch(err => {
                document.getElementById("login-log").innerText = capitalizeFirstLetter(err.toString());
                e.target.disabled = false;
            });
        };

        // Event listeners for signup
        document.getElementById("signup-switch").onclick = () => {
            state = STATES.LOGIN;
            document.getElementById("signup-log").innerText = "";
            document.getElementById("signup-email").value = "";
            document.getElementById("signup-password").value = "";
            document.getElementById("signup-name").value = "";
            document.getElementById("signup-username").value = "";
        };
        document.getElementById("signup-submit").onclick = (e) => {
            e.target.disabled = true;
            userSignup(document.getElementById("signup-name").value, document.getElementById("signup-email").value, document.getElementById("signup-password").value, document.getElementById("signup-username").value).then(status => {
                state = (status) ? STATES.LOGIN : STATES.ACCOUNT;
                e.target.disabled = false;
            }).catch(err => {
                document.getElementById("signup-log").innerText = capitalizeFirstLetter(err.toString());
                e.target.disabled = false;
            });

        };


        // Event listeners for account
        document.getElementById("account-logout").onclick = (e) => {
            e.target.disabled = true;
            userLogout().then(() => {
                state = STATES.LOGIN;
                e.target.disabled = false;
                document.getElementById("account-log").innerText = "";
                document.getElementById("account-email").value = "";
                document.getElementById("account-password").value = "";
                document.getElementById("account-name").value = "";
                document.getElementById("account-username").value = "";
            }).catch(err => {
                document.getElementById("account-log").innerText = capitalizeFirstLetter(err.toString());
                e.target.disabled = false;
            });
        };
        document.getElementById("account-submit").onclick = (e) => {
            e.target.disabled = true;
            userUpdate(document.getElementById("account-name").value, document.getElementById("account-email").value, document.getElementById("account-password").value, document.getElementById("account-username").value).then(() => {
                userData().then(data => {
                    localStorage.setItem("user", JSON.stringify(data));

                    document.getElementById("account-data-name").innerText = data.name;
                    document.getElementById("account-data-email").innerText = data.email;
                    document.getElementById("account-data-username").innerText = data.username;
                    document.getElementById("account-data-highscore").innerText = data.statistics.highscore;
                    document.getElementById("account-data-timeplayed").innerText = data.statistics.time_played;

                    e.target.disabled = false;
                    document.getElementById("account-log").innerText = "";
                    document.getElementById("account-email").value = "";
                    document.getElementById("account-password").value = "";
                    document.getElementById("account-name").value = "";
                    document.getElementById("account-username").value = "";
                }).catch(err => {
                    document.getElementById("account-log").innerText = capitalizeFirstLetter(err.toString());
                });
            }).catch(err => {
                document.getElementById("account-log").innerText = capitalizeFirstLetter(err.toString());
                e.target.disabled = false;
            });
        };
        document.getElementById("account-play").onclick = () => window.location.href = `${window.location.protocol}//${window.location.host}/index.html`;


        verifyToken().then(status => {
            if (status) state = STATES.ACCOUNT;
            else {
                localStorage.removeItem("token");
                localStorage.removeItem("user");
            }
        }).catch(() => {
            state = STATES.LOGIN;
            localStorage.removeItem("token");
            localStorage.removeItem("user");
        }).finally(() => {
            document.getElementById("login-switch").disabled = false;
            document.getElementById("login-submit").disabled = false;

            setInterval(() => {
                switch (state) {
                    case STATES.LOGIN:
                        document.getElementById("state_login").style.display = "block";
                        document.getElementById("state_signup").style.display = "none";
                        document.getElementById("state_account").style.display = "none";
                        break;

                    case STATES.SIGNUP:
                        document.getElementById("state_login").style.display = "none";
                        document.getElementById("state_signup").style.display = "block";
                        document.getElementById("state_account").style.display = "none";
                        break;

                    case STATES.ACCOUNT:
                        let user = JSON.parse(localStorage.getItem("user"));
                        document.getElementById("account-data-name").innerText = user.name;
                        document.getElementById("account-data-email").innerText = user.email;
                        document.getElementById("account-data-username").innerText = user.username;
                        document.getElementById("account-data-highscore").innerText = user.statistics.highscore;
                        document.getElementById("account-data-timeplayed").innerText = user.statistics.time_played;

                        document.getElementById("state_login").style.display = "none";
                        document.getElementById("state_signup").style.display = "none";
                        document.getElementById("state_account").style.display = "block";
                        break;
                }
            }, 15);
        });
    </script>
</body>
</html>