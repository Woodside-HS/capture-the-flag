<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login - Capture the Flag</title>

    <!--
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js" integrity="sha256-yNbKY1y6h2rbVcQtf0b8lq4a+xpktyFc3pSYoGAY1qQ=" crossorigin="anonymous"></script>
    -->
    <script src="lib/jquery.min.js"></script>
    <script src="lib/toastr.min.js"></script>

    <script src="login.js"></script>

    <link rel="stylesheet" type="text/css" href="login.css">

    <!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" integrity="sha256-R91pD48xW+oHbpJYGn5xR0Q7tMhH4xOrWn1QqMRINtA=" crossorigin="anonymous" />
    -->
    <link rel="stylesheet" type="text/css" href="lib/toastr.min.css"/>

</head>
<body>
    <div class="form">
        <div class="form-toggle"></div>
        <div class="form-panel one">
            <div class="form-header">
                <h1>Login</h1>
            </div>
            <div class="form-content">
                <form>
                    <div class="form-group"><label for="email-login">Email</label><input type="email" id="email-login" name="email" required="required" /></div>
                    <div class="form-group"><label for="password-login">Password</label><input type="password" id="password-login" name="password" required="required" /></div>
                    <div class="form-group"><a class="form-recovery" href="#" id="forgot-password">Forgot Password?</a></div>
                    <div class="form-group login"><button type="submit" id="submit-login">Log In</button></div>
                </form>
            </div>
        </div>
        <div class="form-panel two">
            <div class="form-header">
                <h1>Register</h1>
            </div>
            <div class="form-content">
                <form>
                    <div class="form-group"><label for="name-register">Name</label><input type="text" id="name-register" name="name" required="required" /></div>
                    <div class="form-group"><label for="username-register">Username</label><input type="text" id="username-register" name="username" required="required" /></div>
                    <div class="form-group"><label for="email-register">Email</label><input type="email" id="email-register" name="email" required="required" /></div>
                    <div class="form-group"><label for="password-register">Password</label><input type="password" id="password-register" name="password" required="required" /></div>
                    <div class="form-group register"><button type="submit" id="submit-register">Register</button></div>
                </form>
            </div>
        </div>
        <div class="form-panel three" style="display: none">
            <div class="form-header">
                <h1>Account</h1>
            </div>
            <div class="form-content">
                <div class="form-group"><label for="account-name">Name</label><input type="text" id="account-name" name="name" placeholder="Current: " /></div>
                <div class="form-group"><label for="account-username">Username</label><input type="text" id="account-username" name="username" placeholder="Current: " /></div>
                <div class="form-group"><label for="account-email">Email</label><input type="email" id="account-email" name="email" placeholder="Current: " /></div>
                <div class="form-group"><label for="account-password">Password</label><input type="password" id="account-password" name="password" /></div>
                <div class="form-group half"><button id="account-save">Save</button></div>
                <br><br>
                <div class="form-group"><button id="account-logout">Log Out</button></div>
                <div class="form-group"><button id="account-play">Play</button></div>
            </div>
        </div>
        <div class="form-panel four" style="display: none;">
            <div class="form-header">
                <h1>Forgot Password?</h1>
            </div>
            <div class="form-content">
                <div class="form-group"><label for="fp-email">Email</label><input type="email" id="fp-email" name="email"/></div>
                <br>
                <div class="form-group"><a class="form-recovery" href="#" id="fp-back">Back</a></div>
                <div class="form-group half"><button id="submit-fp">Reset</button></div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-bottom-center",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };

            let form_panel_two = $('.form-panel.two');

            let panelOne = form_panel_two.height(),
                panelTwo = form_panel_two[0].scrollHeight;

            let submit_login = $("#submit-login"), submit_register = $("#submit-register");
            submit_login.attr("disabled", true);
            submit_register.attr("disabled", true);

            verifyToken().then(status => {
                if (status) {
                    let user = JSON.parse(localStorage.getItem("user"));

                    $(".form-toggle")[0].style.display = "none";
                    $(".form-panel.one")[0].style.display = "none";
                    $(".form-panel.two")[0].style.display = "none";
                    $(".form-panel.three")[0].style.display = "block";

                    $("#account-name").attr("placeholder", `Current: ${user.name}`);
                    $("#account-username").attr("placeholder", `Current: ${user.username}`);
                    $("#account-email").attr("placeholder", `Current: ${user.email}`);
                } else {
                    localStorage.removeItem("token");
                    localStorage.removeItem("user");
                }
            }).catch(() => {
                localStorage.removeItem("token");
                localStorage.removeItem("user");
            }).finally(() => {
                submit_login.attr("disabled", false);
                submit_register.attr("disabled", false);
            });

            form_panel_two.not('.form-panel.two.active').on('click', function(e) {
                e.preventDefault();

                $('.form-toggle').addClass('visible');
                $('.form-panel.one').addClass('hidden');
                $('.form-panel.two').addClass('active');
                $('.form').animate({
                    'height': panelTwo
                }, 200);
            });

            $('.form-toggle').on('click', function(e) {
                e.preventDefault();
                $(this).removeClass('visible');
                $('.form-panel.one').removeClass('hidden');
                $('.form-panel.two').removeClass('active');
                $('.form').animate({
                    'height': panelOne
                }, 200);
            });

            submit_login.on('click', function (e) {
                e.preventDefault();
                e.target.disabled = true;

                userLogin($("#email-login").val(), $("#password-login").val()).then(() => {
                    userData().then(data => {
                        localStorage.setItem("user", JSON.stringify(data));

                        $(".form-toggle")[0].style.display = "none";
                        $(".form-panel.one")[0].style.display = "none";
                        $(".form-panel.two")[0].style.display = "none";
                        $(".form-panel.three")[0].style.display = "block";

                        $("#account-name").attr("placeholder", `Current: ${data.name}`);
                        $("#account-username").attr("placeholder", `Current: ${data.username}`);
                        $("#account-email").attr("placeholder", `Current: ${data.email}`);

                        $("#email-login").val("");
                        $("#password-login").val("");

                        toastr.success("", "Successfully logged in");
                    }).catch(err => toastr.error(capitalizeFirstLetter(err.toString()), "Unable to get account data"));
                }).catch(err => toastr.error(capitalizeFirstLetter(err.toString()), "Unable to login"))
                    .finally(() => e.target.disabled = false);
            });

            submit_register.on('click', function (e) {
                e.preventDefault();
                e.target.disabled = true;

                userSignup($("#name-register").val(), $("#email-register").val(), $("#password-register").val(), $("#username-register").val()).then(status => {
                    if (status) {
                        $(".form-toggle").click();
                        toastr.success("You may now login", "Successfully created user");
                    } else {
                        toastr.error("An unknown error occurred", "Unable to create user");
                    }

                    $("#name-register").val("");
                    $("#username-register").val("");
                    $("#email-register").val("");
                    $("#password-register").val("");
                }).catch(err => toastr.error(capitalizeFirstLetter(err.toString()), "Unable to Sign Up"))
                    .finally(() => e.target.disabled = false);
            });

            $("#forgot-password").on("click", function (e) {
                e.preventDefault();

                $(".form-toggle")[0].style.display = "none";
                $(".form-panel.one")[0].style.display = "none";
                $(".form-panel.two")[0].style.display = "none";
                $(".form-panel.four")[0].style.display = "block";
            });

            $("#fp-back").on("click", function (e) {
                e.preventDefault();

                $(".form-toggle")[0].style.display = "block";
                $(".form-panel.one")[0].style.display = "block";
                $(".form-panel.two")[0].style.display = "block";
                $(".form-panel.four")[0].style.display = "none";
            });

            $("#submit-fp").on("click", function (e) {
                e.target.disabled = true;
                userForgotPassword($("#fp-email").val()).then(() => {
                    toastr.success("You will recieve an email in 0 to 15mins", "Successfully send reset email");
                    $(".form-toggle")[0].style.display = "block";
                    $(".form-panel.one")[0].style.display = "block";
                    $(".form-panel.two")[0].style.display = "block";
                    $(".form-panel.four")[0].style.display = "none";
                }).catch(err => toastr.error(capitalizeFirstLetter(err), "Unable to reset password"))
                    .finally(() => e.target.disabled = false);
            });

            $("#account-save").on("click", function (e) {
                e.target.disabled = true;
                userUpdate($("#account-name").val(), $("#account-email").val(), $("#account-password").val(), $("#account-username").val()).then(() => {
                    userData().then(data => {
                        localStorage.setItem("user", JSON.stringify(data));

                        $("#account-name").attr("placeholder", `Current: ${data.name}`).val("");
                        $("#account-username").attr("placeholder", `Current: ${data.username}`).val("");
                        $("#account-email").attr("placeholder", `Current: ${data.email}`).val("");
                        $("#account-password").val("");

                        toastr.success("", "Successfully updated information");
                    }).catch(err => toastr.error(capitalizeFirstLetter(err), "Unable to retrieve data"));
                }).catch(err => toastr.error(capitalizeFirstLetter(err), "Unable to update information"))
                    .finally(() => e.target.disabled = false);
            });

            $("#account-logout").on("click", function (e) {
                e.target.disabled = true;
                userLogout().then(() => {
                    $("#account-name").val("");
                    $("#account-username").val("");
                    $("#account-email").val("");
                    $("#account-password").val("");

                    $(".form-toggle")[0].style.display = "block";
                    $(".form-panel.one")[0].style.display = "block";
                    $(".form-panel.two")[0].style.display = "block";
                    $(".form-panel.three")[0].style.display = "none";

                    toastr.success("", "Successfully logged out");
                }).catch(err => toastr.error(capitalizeFirstLetter(err), "Unable to logout"))
                    .finally(() => e.target.disabled = false);
            });

            $("#account-play").on("click", function () {
                window.location.href = "/index.html";
            });
        });
    </script>
</body>
</html>